<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTA Firmware Update</title>
    
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            background-color: blueviolet;
        }
        h1, p {
            margin-top: 0;
            color: yellow;  
        }
        
        #fileList {
            display: none; 
            margin-top: 20px;
            color: white;
        }

        #firmwareFileButton {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: blue;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #successMessage {
            display: none;
            color: green;
            margin-top: 20px;
        }

    </style>
</head>
<body>
    <h1>OTA Firmware Update for Zumo32U4 Robot</h1>
    <p>Welcome to the OTA firmware update page!</p>

    <!-- Button to display the file list -->
    <button id="listFilesButton" onclick="loadFileList()">Choose Firmware File</button>
    <input type="button" id="firmwareFileButton" style="display: none;" />
    <!-- To display file list -->
<div id="fileList" onclick="handleFileSelection(event)"></div>

    <!-- Form for uploading the firmware -->
    <form id="firmwareForm" method="POST" enctype="multipart/form-data" action="/uploadFirmware">
        <!-- Hidden input field for the selected file -->
        <input type="hidden" id="file_id" name="firmware" />
        <!-- Button to perform the firmware update -->
        <input type="button" id="firmwareUpdateButton" value="Update Firmware" onclick="performFirmwareUpdate()" style="display: block;" />
    </form>

<script>
    /* Function to load the file list */
    function loadFileList()
    {
        fetch('/listFirmwareFiles')
            .then(response => response.text())
            .then(data => {
                document.getElementById('fileList').innerHTML = data;
                document.getElementById('fileList').style.display = 'block'; /**<Display the file list.*/
            });
    }

    /* Function to handle file selection */
function handleFileSelection(event)
{
    let selectedFile = event.target.textContent.trim();
    /*Display the selected file.*/
    alert('Selected file: ' + selectedFile);

    /*Save the selected file in a hidden field.*/
    document.getElementById('file_id').value = selectedFile;

    /*Show the 'Choose Firmware File' button and display the 'Firmware Update' button.*/ 
    document.getElementById('firmwareFileButton').style.display = 'block';
    document.getElementById('firmwareUpdateButton').style.display = 'block';
}


    /* Function for firmware update */
    function performFirmwareUpdate()
    {
        /*Retrieve selected file.*/
        let selectedFile = document.getElementById('file_id').value;
        
        /*Debugging: Log the selected file to the console.*/
        console.log('Selected file:', selectedFile);
        
        if (!selectedFile)
        {
            alert('No file selected.');
            return;
        }

        /*Initiate firmware update.*/
        const formData = new FormData();
        formData.append('firmware', selectedFile);

        /*Debugging: Log the formData to the console.*/
        console.log('FormData:', formData);

        fetch('/uploadFirmware', {
            method: "POST",
            body: formData,
        })
        .then(response => {
            if (response.ok)
            {
                /*Firmware update initiated successfully.*/
                alert('Firmware update initiated! Robot will now enter bootloader mode.');
            }
            else
            {
                /*Error during Firmware update.*/
                alert('Error during firmware update!');
            }
        })
        .catch(error => {
            console.error('Error during firmware update:', error);
            alert('Error during firmware update!');
        });
    }

</script>
</body>
</html>
