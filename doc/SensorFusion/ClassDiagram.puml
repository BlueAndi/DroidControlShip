@startuml ClassDiagram
'=== Klassen ===
class App { 
  +setup() : void
  +loop() : void
}
class LineSensors {
  +LineSensors(serMuxChannelProvider: SerMuxChannelProvider&)
  +readLine() : int16_t
  +getSensorValues() const : const uint16_t*
  +getNumLineSensors() : uint8_t <<static>>
  +getSensorValueMax() : int16_t <<static>>
}
class Motors {
  +Motors(serMuxChannelProvider: SerMuxChannelProvider&)
  +setSpeeds(leftSpeed: int16_t, rightSpeed: int16_t) : void
  +getMaxSpeed() const : int16_t
  +setMaxSpeed(maxSpeed: int16_t) : void
}
package "SerialMuxChannels" <<namespace>> {

  ' ===== Enums =====
  package "SMPChannelPayload" <<namespace>> {
    enum CmdId {
      CMD_ID_IDLE
      CMD_ID_START_LINE_SENSOR_CALIB
      CMD_ID_START_MOTOR_SPEED_CALIB
      CMD_ID_REINIT_BOARD
      CMD_ID_GET_MAX_SPEED
      CMD_ID_START_DRIVING
      CMD_ID_SET_INIT_POS
    }
    enum RspId {
      RSP_ID_OK
      RSP_ID_PENDING
      RSP_ID_ERROR
    }
    enum Status {
      STATUS_FLAG_OK
      STATUS_FLAG_ERROR
    }
    enum Range {
      RANGE_NO_OBJECT
      RANGE_25_30
      RANGE_20_25
      RANGE_15_20
      RANGE_10_15
      RANGE_5_10
      RANGE_0_5
    }
  }

  ' ===== Payload-Structs =====
  class Command <<struct>> {
    +commandId : SMPChannelPayload::CmdId
    --
    +xPos : int32_t  ' [mm]   (nur f체r SET_INIT_POS)
    +yPos : int32_t  ' [mm]
    +orientation : int32_t  ' [mrad]
  }

  class CommandResponse <<struct>> {
    +commandId : SMPChannelPayload::CmdId
    +responseId : SMPChannelPayload::RspId
    --
    +maxMotorSpeed : int32_t  ' [mm/s]
  }

  class MotorSpeed <<struct>> {
    +left  : int32_t  ' [mm/s]
    +right : int32_t  ' [mm/s]
  }

  class RobotSpeed <<struct>> {
    +linearCenter : int32_t  ' [mm/s]
    +angular      : int32_t  ' [mrad/s]
  }

  class VehicleData <<struct>> {
    +xPos        : int32_t  ' [mm]
    +yPos        : int32_t  ' [mm]
    +orientation : int32_t  ' [mrad]
    +left        : int32_t  ' [mm/s]
    +right       : int32_t  ' [mm/s]
    +center      : int32_t  ' [mm/s]
    +proximity   : SMPChannelPayload::Range
  }

  class Status <<struct>> {
    +status : SMPChannelPayload::Status
  }

  class LineSensorData <<struct>> {
    +lineSensorData : uint16_t[5]  ' normiert, max 1000
  }

  note as N_channels
  CHANNELS:
   - "CMD"        (DLC = sizeof(Command))
   - "CMD_RSP"    (DLC = sizeof(CommandResponse))
   - "MOTOR_SET"  (DLC = sizeof(MotorSpeed))
   - "ROBOT_SET"  (DLC = sizeof(RobotSpeed))
   - "CURR_DATA"  (DLC = sizeof(VehicleData))
   - "STATUS"     (DLC = sizeof(Status))
   - "LINE_SENS"  (DLC = sizeof(LineSensorData))
  end note
}

interface IState {
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}
class StateMachine {
  +setState(state: IState&) : void
  +getState() : IState*
  +process() : void
}

class SerMuxChannelProvider {
  +SerMuxChannelProvider(stream: Stream&)
  +init() : bool
  +isInSync() : bool
  +process() : void
  --
  +registerLineSensorCallback(callback: LineSensorCallback) : void
  +registerVehicleDataCallback(callback: VehicleDataCallback) : void
  --
  +sendStatus(status: Status) const : bool
  +sendMotorSpeed(motorSpeed: MotorSpeed) const : bool
  +sendRobotSpeed(robotSpeed: RobotSpeed) const : bool
  --
  +requestMaxMotorSpeed(cb: MaxMotorSpeedFunc) : bool
  +requestLineSensorCalibration(cb: LineSensorCalibFunc) : bool
  +requestMotorSpeedCalibration(cb: MotorSpeedCalibFunc) : bool
  +requestReinitBoard(cb: ReinitBoardFunc) : bool
}
'=== States ===

class DrivingState {
  {static} +getInstance() : DrivingState&
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}

class ErrorState {
  {static} +getInstance() : ErrorState&
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}

class LineSensorsCalibrationState {
  {static} +getInstance() : LineSensorsCalibrationState&
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}

class ParameterSets {
  {static} +getInstance() : ParameterSets&
  +choose(setId: uint8_t) : void
  +next() : void
  +getCurrentSetId() const : uint8_t
  +getParameterSet() const : const ParameterSet&
}

class ParameterSet <<struct>> {
  +name : const char*
  +topSpeed : int16_t
  +kPNumerator : int16_t
  +kPDenominator : int16_t
  +kINumerator : int16_t
  +kIDenominator : int16_t
  +kDNumerator : int16_t
  +kDDenominator : int16_t
}


class ReadyState {
  {static} +getInstance() : ReadyState&
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}

class ReleaseTrackState {
  {static} +getInstance() : ReleaseTrackState&
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}
class StartupState {
  {static} +getInstance() : StartupState&
  +entry() : void
  +process(sm: StateMachine&) : void
  +exit() : void
}

' ====== Erg채nzte RELATIONEN ======
' App besitzt diese Komponenten (per Wert) -> Komposition
App *-- StateMachine
App *-- SerMuxChannelProvider
App *-- LineSensors
App *-- Motors

' LineSensors & Motors halten Referenzen auf Provider -> Aggregation
LineSensors o-- SerMuxChannelProvider : uses (ref)
Motors o-- SerMuxChannelProvider : uses (ref)

' LineSensors nutzt LineSensorData (Callback)
LineSensors ..> LineSensorData : uses

' SerMuxChannelProvider nutzt Payload-Typen / Enums
SerMuxChannelProvider ..> CommandResponse : uses
SerMuxChannelProvider ..> MotorSpeed : uses
SerMuxChannelProvider ..> RobotSpeed : uses
SerMuxChannelProvider ..> VehicleData : uses
SerMuxChannelProvider ..> Status : uses
SerMuxChannelProvider ..> LineSensorData : uses
SerMuxChannelProvider ..> SMPChannelPayload::RspId : uses
SerMuxChannelProvider ..> SMPChannelPayload::CmdId : uses

' StateMachine h채lt Zeiger auf IState (current/next)
StateMachine o-- IState : current/next

' Alle States erben von IState
DrivingState -|> IState
ErrorState -|> IState
LineSensorsCalibrationState -|> IState
ReadyState -|> IState
ReleaseTrackState -|> IState
StartupState -|> IState

' States: Abh채ngigkeiten & Kompositionen
' DrivingState nutzt LineSensors & Motors (Zeiger), besitzt Timer & PID
DrivingState ..> LineSensors : uses (ptr)
DrivingState ..> Motors : uses (ptr)

' ReadyState besitzt Timer, nutzt LineSensors
ReadyState ..> LineSensors : uses (ptr)

' LineSensorsCalibrationState nutzt Provider
LineSensorsCalibrationState ..> SerMuxChannelProvider : uses (ptr)

' StartupState nutzt Provider & Motors, besitzt Timer
StartupState ..> SerMuxChannelProvider : uses (ptr)
StartupState ..> Motors : uses (ptr)

@enduml